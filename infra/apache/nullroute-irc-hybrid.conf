# NullRoute IRC - Hybrid Architecture (Phoenix + Go Gateway)
# Apache proxies to Phoenix (port 4000), Phoenix Channels at /socket
#
# Docs: https://httpd.apache.org/docs/current/mod/mod_proxy.html (Websocket Upgrade 2.4.47+)
#       https://httpd.apache.org/docs/current/mod/mod_proxy_wstunnel.html
# Phoenix: https://hexdocs.pm/phoenix/writing_a_channels_client.html (path: /socket/websocket)
#
# Required: a2enmod proxy proxy_http proxy_wstunnel
# Replace DOMAIN_NAME with your domain (e.g. irc.example.com)

<VirtualHost *:80>
    ServerName DOMAIN_NAME
    # ServerAlias: add chat subdomain if needed, e.g. chat.example.com

    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket for Phoenix Channels - MUST come before other ProxyPass
    # mod_proxy_wstunnel (Apache 2.4.5+) - more reliable than upgrade=websocket
    ProxyPass "/socket/" "ws://localhost:4000/socket/"
    ProxyPassReverse "/socket/" "ws://localhost:4000/socket/"

    # Phoenix HTTP
    ProxyPass /api/ http://localhost:4000/api/
    ProxyPassReverse /api/ http://localhost:4000/api/
    ProxyPass / http://localhost:4000/
    ProxyPassReverse / http://localhost:4000/

    ProxyTimeout 300

    ErrorLog ${APACHE_LOG_DIR}/nullroute-irc-error.log
    CustomLog ${APACHE_LOG_DIR}/nullroute-irc-access.log combined
</VirtualHost>
